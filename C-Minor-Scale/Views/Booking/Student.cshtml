@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";

}

<div class="jumbotron">
    <h1>Booking</h1>
    <p class="lead">Here you are able to book a seat in one of our computer labs. We hope this will make your studies here at Jönköping University more pleasant. </p>
    @*<p><a href="http://asp.net" class="btn btn-primary btn-lg">Booking &raquo;</a></p>*@
</div>
<div class="row">
    
    <input type="date" id="date"/>
    <input type="time" id="startTime"/>
    <input type="time" id="endTime"/>

    <div class="col-md-4" id="2440">
        <h2>Computerlab 2440</h2>
       
    </div>
    <div class="col-md-4" id="1330">
        <h2>Computerlab 1330</h2>
            </div>
    
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js" type="text/javascript"></script>


<script>

    $(document).ready(function () {

           $.ajax({
               url: "https://stage-core.intelligentdesk.com/zone?realm=true&parent=5115225993379840",
               type: "GET",
               headers: {
                   'idesk-auth-method': 'up',
                   'idesk-auth-username': localStorage.getItem("user"),
                   'idesk-auth-password': localStorage.getItem('password'),
                   'Accept': 'application/vnd.idesk-v5+json'
                   },
               contentType: 'application/vnd.idesk-v5+json',
               success: function (data) {
                   alert('Success!');
                   for (var i = 0; i < data.length; i++)
                   {
                       if (data[i].Type == 'DESK')
                       {

                           var button = document.createElement("input")
                           button.value = data[i].Name
                           button.setAttribute("class", "btn btn-primary btn-lg")
                           button.type = "button"

                           $(button).click(book(data[i].LastModified, data[i].Zid))

                           if (data[i].Name.split(" ")[1] < 5)
                           {
                               var parentdiv = document.getElementById('2440')
                               parentdiv.appendChild(button)
                           }
                           else
                           {
                               var parentdiv = document.getElementById('1330')
                               parentdiv.appendChild(button)
                           }
                           
                       }
                   }
               },

               error: function (data) {
                   alert(JSON.parse(data.responseText).Message);}
           });
    })




    function book(Lastmodified, Zid) {

        return function () {
            var startTime = new Date(document.getElementById('date').value)
            var endTime = new Date(document.getElementById('date').value)

            startTime.setHours(document.getElementById('startTime').value.split(':')[0])
            startTime.setMinutes(document.getElementById('startTime').value.split(':')[1])
            //console.log(startTime)

            endTime.setHours(document.getElementById('endTime').value.split(':')[0])
            endTime.setMinutes(document.getElementById('endTime').value.split(':')[1])
            //console.log(endTime)

            startTime = Math.round(startTime / 1000.0)
            endTime = Math.round(endTime / 1000.0)
            //console.log(
            //    JSON.stringify({
            //        "Owner": localStorage.getItem("user"),
            //        "Lastmodified": Lastmodified,
            //        "From": startTime,
            //        "Until": endTime,
            //        "Zid": Zid,
            //        "Subject": "bookingtest",
            //        "Private": "false"

            //    }))

            $.ajax({
                url: "http://localhost:60156/api/bookingapi",
                type: "POST",
                headers: {
                    'idesk-auth-method': 'up',
                    'idesk-auth-username': localStorage.getItem('user'),
                    'idesk-auth-password': localStorage.getItem('password'),
                    'Accept': 'application/json',
                    //'Accept': 'application/vnd.idesk-v5+json'
                },
                data: JSON.stringify({
                    "Owner": localStorage.getItem("user"),
                    "Lastmodified": Lastmodified,
                    "From": startTime+'000',
                    "Until": endTime+'000',
                    "Zid": Zid,
                    "Subject": "bookingtest",
                    "Private": "false"

                }),
                contentType: 'application/json',
                //contentType: 'application/vnd.idesk-v5+json',
                success: function (data) {
                    alert('Success!');
                    //console.log(data)
                },

                error: function (data) {
                    alert("Error");
                    console.log(data.responseText);
                }
            });
        }
    }

</script>