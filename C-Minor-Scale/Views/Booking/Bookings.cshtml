@{
    ViewBag.Title = "Bookings";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Your bookings</h1>
<table class="table" id="bookingsTable">
    <thead>
        <tr>
            <th>Desk</th>
            <th>Subject</th>
            <th>From</th>
            <th>Until</th>
        </tr>
    </thead>
    <tbody id="bookingsTbody">
    </tbody>
</table>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="~/Scripts/moment-with-locales.min.js" type="text/javascript"></script>
<script src="~/Scripts/moment-timezone-with-data-2012-2022.min.js" type="text/javascript"></script>

<script>

$(document).ready(function () {
    updateBookingsTable();
})

function updateBookingsTable() {
    var from = Math.floor((new Date()).getTime()) - 1000 * 60 * 60 * 3;
    var until = from + 1000 * 60 * 60 * 24 * 31;

    $.ajax({
        url: "https://stage-booking.intelligentdesk.com/booking?username="+localStorage.getItem("user")+"&from=" + from + "&until=" + until,
        type: "GET",
        headers: {
            'idesk-auth-method': 'up',
            'idesk-auth-username': localStorage.getItem("user"),
            'idesk-auth-password': localStorage.getItem('password'),
            'Accept': 'application/vnd.idesk-v5+json'
        },
        contentType: 'application/vnd.idesk-v5+json',
        success: function (bookings) {
            bookings.sort(SortByStart)
            for (var i = 0; i < bookings.length; i++) {
                tdid = "booking" + i;
                $("<tr><td id=\"" + tdid + "\"></td><td>" + bookings[i].Subject + "</td><td>" + moment.utc(bookings[i].From).tz("Europe/Stockholm").format("YYYY-MM-DD HH:mm") + "</td><td>" + moment.utc(bookings[i].Until).tz("Europe/Stockholm").format("YYYY-MM-DD HH:mm") + "</td>").appendTo("#bookingsTbody");
                updateBookingsTableEntry(tdid, bookings[i].Zid);
            }
        },
        error: function (data) {
            alert(JSON.parse(data.responseText).Message);
        }
    });
}

function SortByStart(a, b) {
    var aFrom = a.From;
    var bFrom = b.From;
    return ((aFrom < bFrom) ? -1 : ((aFrom > bFrom) ? 1 : 0));
}

function updateBookingsTableEntry(tdid, zid) {
    $.ajax({
        url: "https://stage-core.intelligentdesk.com/zone/" + zid,
        type: "GET",
        headers: {
            'idesk-auth-method': 'up',
            'idesk-auth-username': localStorage.getItem("user"),
            'idesk-auth-password': localStorage.getItem('password'),
            'Accept': 'application/vnd.idesk-v5+json'
        },
        contentType: 'application/vnd.idesk-v5+json',
        success: function (zoneInfo) {
            $("#" + tdid).replaceWith("<td>" + zoneInfo.Name + "</td>");
        },
        error: function (data) {
            alert(JSON.parse(data.responseText).Message);
        }
    });
}

</script>
